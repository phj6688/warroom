<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Research War Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green: #00ff41;
  --green-dim: #00cc33;
  --green-dark: #004d13;
  --green-glow: rgba(0, 255, 65, 0.3);
  --bg: #000000;
  --bg-panel: rgba(0, 20, 5, 0.85);
  --bg-card: rgba(0, 40, 10, 0.6);
  --border: rgba(0, 255, 65, 0.15);
  --border-bright: rgba(0, 255, 65, 0.4);
  --text: #00ff41;
  --text-dim: rgba(0, 255, 65, 0.6);
  --text-dimmer: rgba(0, 255, 65, 0.35);
  --danger: #ff4141;
  --warning: #ffaa00;
  --sidebar-width: 260px;
  --right-panel-width: 320px;
  --top-bar-height: 64px;
  --bottom-bar-height: 80px;
  --font: 'JetBrains Mono', monospace;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: 13px;
  line-height: 1.5;
  overflow: hidden;
}

/* â”€â”€â”€ Matrix Rain Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#matrix-rain {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
  opacity: 0.06;
  pointer-events: none;
}

/* â”€â”€â”€ Scanlines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scanlines {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 9999;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 0, 0, 0.15) 0px,
    rgba(0, 0, 0, 0.15) 1px,
    transparent 1px,
    transparent 3px
  );
}

/* â”€â”€â”€ CRT Flicker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes crt-flicker {
  0% { opacity: 0.97; }
  5% { opacity: 0.95; }
  10% { opacity: 0.98; }
  15% { opacity: 0.96; }
  20% { opacity: 0.99; }
  100% { opacity: 0.97; }
}

.crt-effect {
  animation: crt-flicker 8s infinite;
}

/* â”€â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: relative;
  z-index: 1;
}

.top-bar {
  height: var(--top-bar-height);
  display: flex;
  align-items: center;
  padding: 0 20px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  gap: 16px;
  flex-shrink: 0;
}

.top-bar .logo {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  white-space: nowrap;
  text-shadow: 0 0 10px var(--green-glow);
}

.top-bar .problem-display {
  flex: 1;
  font-size: 12px;
  color: var(--text-dim);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 8px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  min-height: 36px;
  display: flex;
  align-items: center;
}

.top-bar .status-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  white-space: nowrap;
}

.status-badge.active {
  background: rgba(0, 255, 65, 0.15);
  border: 1px solid var(--green-dim);
  color: var(--green);
}

.status-badge.idle {
  background: rgba(0, 255, 65, 0.05);
  border: 1px solid var(--border);
  color: var(--text-dim);
}

.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* â”€â”€â”€ Left Sidebar (Agents) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-width);
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-dim);
}

.agent-list {
  padding: 8px;
  flex: 1;
}

.agent-card {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 4px;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  cursor: default;
  border: 1px solid transparent;
}

.agent-card:hover {
  background: var(--bg-card);
  border-color: var(--border);
}

.agent-card.thinking {
  background: rgba(0, 255, 65, 0.08);
  border-color: var(--border-bright);
}

.agent-card.speaking {
  background: rgba(0, 255, 65, 0.12);
  border-color: var(--green-dim);
  box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
}

.agent-emoji {
  font-size: 22px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  background: var(--bg-card);
  margin-right: 10px;
  flex-shrink: 0;
}

.agent-info {
  flex: 1;
  min-width: 0;
}

.agent-name {
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.agent-role {
  font-size: 10px;
  color: var(--text-dimmer);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.agent-status {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-dimmer);
  flex-shrink: 0;
  margin-left: 8px;
  transition: all 0.3s ease;
}

.agent-status.thinking {
  background: var(--warning);
  box-shadow: 0 0 8px rgba(255, 170, 0, 0.5);
  animation: pulse 1.5s ease-in-out infinite;
}

.agent-status.speaking {
  background: var(--green);
  box-shadow: 0 0 8px var(--green-glow);
  animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
}

/* â”€â”€â”€ Center Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feed-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

.feed {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  scroll-behavior: smooth;
}

.feed::-webkit-scrollbar { width: 6px; }
.feed::-webkit-scrollbar-track { background: transparent; }
.feed::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }

/* Phase Separator */
.phase-separator {
  display: flex;
  align-items: center;
  margin: 24px 0;
  gap: 16px;
  animation: fadeSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.phase-separator .line {
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-bright), transparent);
}

.phase-separator .label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--green);
  padding: 6px 16px;
  border: 1px solid var(--border-bright);
  border-radius: 20px;
  background: var(--bg-card);
  text-shadow: 0 0 8px var(--green-glow);
  white-space: nowrap;
}

/* Message Bubble */
.message {
  margin-bottom: 16px;
  animation: fadeSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.message-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid var(--border);
  background: var(--bg-card);
}

.message-badge .emoji {
  font-size: 14px;
}

.message-phase {
  font-size: 10px;
  color: var(--text-dimmer);
  margin-left: auto;
}

.message-time {
  font-size: 10px;
  color: var(--text-dimmer);
}

.message-body {
  padding: 14px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.7;
  white-space: pre-wrap;
  word-wrap: break-word;
  backdrop-filter: blur(10px);
}

.message-body strong, .message-body b {
  color: var(--green);
  font-weight: 600;
}

/* Escalation Card (inline in feed) */
.escalation-card {
  margin: 16px 0;
  padding: 16px;
  background: rgba(255, 65, 65, 0.08);
  border: 1px solid rgba(255, 65, 65, 0.3);
  border-radius: 12px;
  animation: escalation-glow 2s ease-in-out infinite;
}

@keyframes escalation-glow {
  0%, 100% { box-shadow: 0 0 10px rgba(255, 65, 65, 0.1); }
  50% { box-shadow: 0 0 25px rgba(255, 65, 65, 0.2); }
}

.escalation-card.answered {
  animation: none;
  border-color: rgba(0, 255, 65, 0.3);
  background: rgba(0, 255, 65, 0.05);
}

.escalation-card .esc-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--danger);
}

.escalation-card.answered .esc-header {
  color: var(--green);
}

.escalation-card .esc-question {
  font-size: 13px;
  color: var(--text);
  margin-bottom: 10px;
}

.escalation-card .esc-input-row {
  display: flex;
  gap: 8px;
}

.escalation-card .esc-input {
  flex: 1;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 65, 65, 0.3);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text);
  font-family: var(--font);
  font-size: 12px;
  outline: none;
}

.escalation-card .esc-input:focus {
  border-color: var(--green);
}

.escalation-card .esc-submit {
  padding: 8px 16px;
  background: rgba(0, 255, 65, 0.15);
  border: 1px solid var(--green-dim);
  border-radius: 8px;
  color: var(--green);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.escalation-card .esc-submit:hover {
  background: rgba(0, 255, 65, 0.25);
}

.escalation-card .esc-answer {
  margin-top: 8px;
  padding: 8px 12px;
  background: rgba(0, 255, 65, 0.08);
  border-radius: 8px;
  font-size: 12px;
  color: var(--green);
}

/* Thinking indicator */
.thinking-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 18px;
  margin-bottom: 16px;
  animation: fadeSlideIn 0.3s ease;
}

.thinking-dots {
  display: flex;
  gap: 4px;
}

.thinking-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green-dim);
  animation: dot-bounce 1.4s ease-in-out infinite;
}

.thinking-dots span:nth-child(2) { animation-delay: 0.16s; }
.thinking-dots span:nth-child(3) { animation-delay: 0.32s; }

@keyframes dot-bounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}

.thinking-label {
  font-size: 11px;
  color: var(--text-dim);
  font-style: italic;
}

/* â”€â”€â”€ Right Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.right-panel {
  width: var(--right-panel-width);
  background: var(--bg-panel);
  border-left: 1px solid var(--border);
  backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
  transition: width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
}

.right-panel.collapsed {
  width: 0;
  overflow: hidden;
  opacity: 0;
  border: none;
}

.right-panel-toggle {
  position: absolute;
  right: var(--right-panel-width);
  top: calc(var(--top-bar-height) + 12px);
  z-index: 10;
  width: 28px;
  height: 28px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-dim);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.3s ease;
}

.right-panel-toggle:hover {
  border-color: var(--green);
  color: var(--green);
}

.right-panel-toggle.collapsed {
  right: 8px;
}

.panel-section {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.panel-section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-dim);
  margin-bottom: 12px;
}

/* Phase Progress */
.phase-list {
  list-style: none;
}

.phase-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  font-size: 12px;
  color: var(--text-dimmer);
  transition: all 0.3s ease;
}

.phase-item.active {
  color: var(--green);
}

.phase-item.completed {
  color: var(--text-dim);
}

.phase-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid var(--text-dimmer);
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.phase-item.active .phase-dot {
  border-color: var(--green);
  background: var(--green);
  box-shadow: 0 0 8px var(--green-glow);
}

.phase-item.completed .phase-dot {
  border-color: var(--green-dim);
  background: var(--green-dim);
}

/* Escalation Queue */
.escalation-queue-item {
  padding: 10px;
  background: var(--bg-card);
  border: 1px solid rgba(255, 65, 65, 0.2);
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.escalation-queue-item:hover {
  border-color: rgba(255, 65, 65, 0.4);
}

.escalation-queue-item.answered {
  border-color: rgba(0, 255, 65, 0.2);
  opacity: 0.7;
}

.escalation-queue-item .eq-agent {
  font-weight: 600;
  margin-bottom: 4px;
}

.escalation-queue-item .eq-question {
  color: var(--text-dim);
}

/* Session Info */
.session-info-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 11px;
}

.session-info-item .label {
  color: var(--text-dimmer);
}

.session-info-item .value {
  color: var(--text-dim);
}

/* â”€â”€â”€ Bottom Input Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-bar {
  height: var(--bottom-bar-height);
  padding: 12px 20px;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.input-wrapper {
  flex: 1;
  position: relative;
}

.main-input {
  width: 100%;
  padding: 12px 18px;
  background: rgba(0, 20, 5, 0.8);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: var(--font);
  font-size: 13px;
  outline: none;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.main-input:focus {
  border-color: var(--green-dim);
  box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
}

.main-input::placeholder {
  color: var(--text-dimmer);
}

.submit-btn {
  padding: 12px 24px;
  background: rgba(0, 255, 65, 0.12);
  border: 1px solid var(--green-dim);
  border-radius: 12px;
  color: var(--green);
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  white-space: nowrap;
  min-height: 44px;
  min-width: 44px;
}

.submit-btn:hover {
  background: rgba(0, 255, 65, 0.2);
  transform: scale(1.03);
}

.submit-btn:active {
  transform: scale(0.97);
}

.submit-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.stop-btn {
  padding: 12px 18px;
  background: rgba(255, 65, 65, 0.12);
  border: 1px solid rgba(255, 65, 65, 0.4);
  border-radius: 12px;
  color: var(--danger);
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
  transition: all 0.2s ease;
  display: none;
}

.stop-btn.visible { display: block; }
.stop-btn:hover { background: rgba(255, 65, 65, 0.2); }

/* â”€â”€â”€ Welcome Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  padding: 40px 20px;
}

.welcome h1 {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 4px;
  text-transform: uppercase;
  margin-bottom: 8px;
  text-shadow: 0 0 20px var(--green-glow);
}

.welcome .subtitle {
  font-size: 13px;
  color: var(--text-dim);
  margin-bottom: 32px;
  max-width: 500px;
}

.welcome .prompt {
  font-size: 12px;
  color: var(--text-dimmer);
  margin-bottom: 24px;
  animation: blink 1.5s ease-in-out infinite;
}

.welcome-input-area {
  width: 100%;
  max-width: 640px;
}

.welcome-textarea {
  width: 100%;
  min-height: 120px;
  max-height: 300px;
  padding: 16px 20px;
  background: rgba(0, 20, 5, 0.9);
  border: 1px solid var(--border-bright);
  border-radius: 14px;
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.6;
  resize: vertical;
  outline: none;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.welcome-textarea:focus {
  border-color: var(--green);
  box-shadow: 0 0 20px rgba(0, 255, 65, 0.15);
}

.welcome-textarea::placeholder {
  color: var(--text-dimmer);
}

.welcome-submit {
  margin-top: 16px;
  padding: 14px 40px;
  background: rgba(0, 255, 65, 0.15);
  border: 1px solid var(--green-dim);
  border-radius: 12px;
  color: var(--green);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  min-height: 48px;
  text-shadow: 0 0 8px var(--green-glow);
}

.welcome-submit:hover {
  background: rgba(0, 255, 65, 0.25);
  transform: scale(1.03);
  box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
}

.welcome-submit:active {
  transform: scale(0.97);
}

/* File drop zone */
.file-drop-zone {
  margin-top: 16px;
  padding: 20px;
  border: 2px dashed var(--border-bright);
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-dimmer);
  font-size: 12px;
  position: relative;
}

.file-drop-zone:hover, .file-drop-zone.dragover {
  border-color: var(--green);
  background: rgba(0, 255, 65, 0.05);
  color: var(--green);
}

.file-drop-zone input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.file-list {
  margin-top: 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.file-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 11px;
  color: var(--text-dim);
}

.file-chip .remove-file {
  cursor: pointer;
  color: var(--danger);
  font-size: 14px;
  line-height: 1;
}

.file-chip .remove-file:hover {
  color: #ff6b6b;
}

/* Human chat during deliberation */
.human-chat-bar {
  padding: 10px 20px;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  align-items: center;
}

.human-chat-bar .chat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dimmer);
  white-space: nowrap;
}

.human-chat-bar input {
  flex: 1;
  padding: 10px 14px;
  background: rgba(0, 20, 5, 0.8);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: var(--font);
  font-size: 12px;
  outline: none;
}

.human-chat-bar input:focus {
  border-color: var(--green-dim);
  box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
}

.human-chat-bar button {
  padding: 10px 18px;
  background: rgba(0, 255, 65, 0.12);
  border: 1px solid var(--green-dim);
  border-radius: 10px;
  color: var(--green);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  min-height: 40px;
  white-space: nowrap;
  transition: all 0.2s ease;
}

.human-chat-bar button:hover {
  background: rgba(0, 255, 65, 0.2);
}

/* Human message in feed */
.message.human-msg .message-body {
  background: rgba(0, 255, 65, 0.08);
  border-color: var(--green-dim);
}

.message.human-msg .message-badge {
  border-color: var(--green-dim);
  background: rgba(0, 255, 65, 0.1);
}

/* Attached files badge in top bar */
.files-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 11px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-dim);
  cursor: pointer;
}

.files-badge:hover {
  border-color: var(--green);
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* â”€â”€â”€ Notification toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  top: 80px;
  right: 340px;
  z-index: 100;
  padding: 12px 20px;
  background: rgba(255, 65, 65, 0.15);
  border: 1px solid rgba(255, 65, 65, 0.4);
  border-radius: 10px;
  color: var(--danger);
  font-size: 12px;
  font-weight: 600;
  backdrop-filter: blur(10px);
  animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  cursor: pointer;
  display: none;
}

.toast.visible { display: block; }

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* â”€â”€â”€ Deliberation Complete Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.complete-banner {
  text-align: center;
  padding: 20px;
  margin: 20px 0;
  border: 1px solid var(--border-bright);
  border-radius: 12px;
  background: rgba(0, 255, 65, 0.05);
  animation: fadeSlideIn 0.5s ease;
}

.complete-banner h3 {
  font-size: 14px;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 4px;
  text-shadow: 0 0 10px var(--green-glow);
}

.complete-banner p {
  font-size: 11px;
  color: var(--text-dim);
}

/* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1024px) {
  .right-panel { display: none; }
  .right-panel-toggle { display: none; }
}

@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    height: auto;
    max-height: 50vh;
    z-index: 50;
    border-right: none;
    border-top: 1px solid var(--border);
    flex-direction: column;
    display: none;
  }

  .sidebar.mobile-open {
    display: flex;
  }

  .agent-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    padding: 8px;
  }

  .agent-card {
    flex: 0 0 calc(50% - 4px);
    padding: 8px;
  }

  .main-content {
    flex-direction: column;
  }

  .top-bar .logo {
    font-size: 12px;
    letter-spacing: 1px;
  }

  .mobile-toggle {
    display: flex !important;
  }

  .feed { padding: 12px; }
}

.mobile-toggle {
  display: none;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 18px;
  flex-shrink: 0;
}

/* â”€â”€â”€ Custom scrollbar for sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-track { background: transparent; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.right-panel::-webkit-scrollbar { width: 4px; }
.right-panel::-webkit-scrollbar-track { background: transparent; }
.right-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>
<canvas id="matrix-rain"></canvas>
<div class="scanlines"></div>

<div class="app crt-effect">
  <!-- Top Bar -->
  <div class="top-bar">
    <button class="mobile-toggle" id="mobile-toggle-btn">â˜°</button>
    <div class="logo">âš¡ War Room</div>
    <div class="problem-display" id="problem-display">No active session â€” submit a problem to begin</div>
    <div class="status-badge idle" id="status-badge">Idle</div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">Agents</div>
      <div class="agent-list" id="agent-list"></div>
    </div>

    <!-- Center Feed -->
    <div class="feed-container">
      <div class="feed" id="feed">
        <div class="welcome" id="welcome">
          <h1>AI Research War Room</h1>
          <div class="subtitle">8 cognitive agents with distinct thinking styles collaborate to solve complex problems through structured deliberation.</div>
          <div class="prompt">â–¸ Describe your problem below _</div>
          <div class="welcome-input-area">
            <textarea class="welcome-textarea" id="welcome-input" placeholder="Describe a complex problem, strategic question, or research challenge...&#10;&#10;Example: How should we architect a knowledge graph for insurance tariff data that needs to support both automated matching and human exploration?"></textarea>
            <div class="file-drop-zone" id="file-drop-zone">
              ğŸ“ Drop files here or click to attach (documents, data, references â€” max 10MB each)
              <input type="file" id="file-input" multiple>
            </div>
            <div class="file-list" id="file-list"></div>
            <button class="welcome-submit" id="welcome-submit">âš¡ Deploy War Room</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel" id="right-panel">
      <div class="panel-section">
        <div class="panel-section-title">Phase Progress</div>
        <ul class="phase-list" id="phase-list"></ul>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Escalation Queue</div>
        <div id="escalation-queue"><span style="font-size:11px;color:var(--text-dimmer)">No escalations yet</span></div>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Session Info</div>
        <div id="session-info">
          <div class="session-info-item"><span class="label">Status</span><span class="value" id="info-status">Idle</span></div>
          <div class="session-info-item"><span class="label">Messages</span><span class="value" id="info-messages">0</span></div>
          <div class="session-info-item"><span class="label">Escalations</span><span class="value" id="info-escalations">0</span></div>
          <div class="session-info-item"><span class="label">Duration</span><span class="value" id="info-duration">â€”</span></div>
        </div>
      </div>
    </div>

    <button class="right-panel-toggle" id="right-panel-toggle">â—‚</button>
  </div>

  <!-- Human Chat Bar (visible during active session) -->
  <div class="human-chat-bar" id="human-chat-bar" style="display:none">
    <span class="chat-label">ğŸ’¬ You</span>
    <input type="text" id="human-chat-input" placeholder="Interject â€” add context, answer questions, redirect agents..." autocomplete="off">
    <button id="human-send-btn">Send</button>
    <button class="stop-btn visible" id="stop-session-btn" style="display:inline-block;padding:10px 14px;font-size:11px">â–  Stop</button>
  </div>

  <!-- Bottom Input Bar (visible when idle) -->
  <div class="bottom-bar" id="bottom-bar">
    <div class="input-wrapper">
      <input type="text" class="main-input" id="main-input" placeholder="Or type a quick problem here..." autocomplete="off">
    </div>
    <button class="submit-btn" id="submit-btn">Deploy â–¸</button>
  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ Matrix Rain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('matrix-rain');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const chars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³0123456789ABCDEF';
const fontSize = 14;
let columns = Math.floor(canvas.width / fontSize);
let drops = Array(columns).fill(1);

function drawMatrix() {
  ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#00ff41';
  ctx.font = fontSize + 'px monospace';

  for (let i = 0; i < drops.length; i++) {
    const text = chars[Math.floor(Math.random() * chars.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
      drops[i] = 0;
    }
    drops[i]++;
  }
}

setInterval(drawMatrix, 50);

window.addEventListener('resize', () => {
  columns = Math.floor(canvas.width / fontSize);
  drops = Array(columns).fill(1);
});

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null;
let agents = [];
let phases = [];
let currentSession = null;
let messageCount = 0;
let escalationCount = 0;
let sessionStart = null;
let durationInterval = null;
let pendingFiles = []; // Files staged for upload

// â”€â”€â”€ Base Path (proxy-aware) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Detect if we're behind a reverse proxy like /proxy/war-room/
const BASE_PATH = (() => {
  const m = location.pathname.match(/^(\/proxy\/[^/]+)/);
  return m ? m[1] : '';
})();
function apiUrl(path) { return BASE_PATH + path; }

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getWsUrl() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  return `${proto}//${location.host}${BASE_PATH}`;
}

function connect() {
  ws = new WebSocket(getWsUrl());

  ws.onopen = () => {
    console.log('Connected to War Room');
  };

  ws.onclose = () => {
    console.log('Disconnected, reconnecting in 3s...');
    setTimeout(connect, 3000);
  };

  ws.onerror = (err) => {
    console.error('WebSocket error:', err);
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleMessage(data);
  };
}

function handleMessage(data) {
  switch (data.type) {
    case 'agents':
      agents = data.agents;
      renderAgentList();
      break;

    case 'phases':
      phases = data.phases;
      renderPhaseList();
      break;

    case 'session-created':
      currentSession = data.session;
      sessionStart = Date.now();
      messageCount = 0;
      escalationCount = 0;
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('problem-display').textContent = data.session.problem;
      if (data.session.files && data.session.files.length > 0) {
        document.getElementById('problem-display').innerHTML += ` <span class="files-badge">ğŸ“ ${data.session.files.length} file${data.session.files.length > 1 ? 's' : ''}</span>`;
      }
      document.getElementById('status-badge').textContent = 'Active';
      document.getElementById('status-badge').className = 'status-badge active';
      document.getElementById('bottom-bar').style.display = 'none';
      document.getElementById('human-chat-bar').style.display = 'flex';
      document.getElementById('info-status').textContent = 'Active';
      startDurationTimer();
      clearFeed();
      break;

    case 'phase-change':
      updatePhaseList(data.phase);
      addPhaseSeparator(data.phaseName);
      break;

    case 'agent-state':
      updateAgentState(data.agentId, data.state);
      if (data.state === 'thinking') {
        showThinkingIndicator(data.agentId);
      } else {
        removeThinkingIndicator(data.agentId);
      }
      break;

    case 'message':
      removeThinkingIndicator(data.agentId);
      addMessage(data);
      messageCount++;
      document.getElementById('info-messages').textContent = messageCount;
      break;

    case 'escalation':
      addEscalationInline(data);
      addEscalationToQueue(data);
      escalationCount++;
      document.getElementById('info-escalations').textContent = escalationCount;
      showToast(`ğŸ”´ ${data.agentName} needs your input!`);
      break;

    case 'escalation-answered':
      markEscalationAnswered(data.escalationId, data.answer);
      break;

    case 'waiting-for-human':
      showToast(`â³ Waiting for ${data.pendingCount} human response(s)...`);
      break;

    case 'escalation-timeout':
      showToast('â° Proceeding without human input');
      break;

    case 'human-message':
      addHumanMessageToFeed(data);
      break;

    case 'deliberation-complete':
      addCompleteBanner();
      document.getElementById('status-badge').textContent = 'Complete';
      document.getElementById('status-badge').className = 'status-badge idle';
      document.getElementById('bottom-bar').style.display = 'flex';
      document.getElementById('human-chat-bar').style.display = 'none';
      document.getElementById('info-status').textContent = 'Complete';
      stopDurationTimer();
      resetAgentStates();
      break;

    case 'session-stopped':
      document.getElementById('status-badge').textContent = 'Stopped';
      document.getElementById('status-badge').className = 'status-badge idle';
      document.getElementById('bottom-bar').style.display = 'flex';
      document.getElementById('human-chat-bar').style.display = 'none';
      document.getElementById('info-status').textContent = 'Stopped';
      stopDurationTimer();
      resetAgentStates();
      break;

    case 'error':
      console.error('Server error:', data.message);
      showToast(`âš ï¸ ${data.message}`);
      break;

    case 'session-state':
      // Replay full session state
      currentSession = data.session;
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('problem-display').textContent = data.session.problem;
      clearFeed();
      let lastPhase = '';
      data.session.messages.forEach(msg => {
        if (msg.phase !== lastPhase) {
          addPhaseSeparator(msg.phase);
          lastPhase = msg.phase;
        }
        addMessage(msg);
      });
      data.session.escalations.forEach(esc => {
        addEscalationToQueue(esc);
      });
      messageCount = data.session.messages.length;
      escalationCount = data.session.escalations.length;
      document.getElementById('info-messages').textContent = messageCount;
      document.getElementById('info-escalations').textContent = escalationCount;
      break;
  }
}

// â”€â”€â”€ Render Agent List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAgentList() {
  const list = document.getElementById('agent-list');
  list.innerHTML = agents.map(a => `
    <div class="agent-card" id="agent-card-${a.id}">
      <div class="agent-emoji">${a.emoji}</div>
      <div class="agent-info">
        <div class="agent-name" style="color:${a.color}">${a.name}</div>
        <div class="agent-role">${a.role}</div>
      </div>
      <div class="agent-status" id="agent-status-${a.id}"></div>
    </div>
  `).join('');
}

function updateAgentState(agentId, state) {
  const card = document.getElementById(`agent-card-${agentId}`);
  const dot = document.getElementById(`agent-status-${agentId}`);
  if (!card || !dot) return;

  card.className = `agent-card ${state}`;
  dot.className = `agent-status ${state}`;
}

function resetAgentStates() {
  agents.forEach(a => updateAgentState(a.id, 'idle'));
}

// â”€â”€â”€ Render Phase List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhaseList() {
  const list = document.getElementById('phase-list');
  list.innerHTML = phases.map((p, i) => `
    <li class="phase-item" id="phase-item-${i}">
      <div class="phase-dot"></div>
      <span>${p.name}</span>
    </li>
  `).join('');
}

function updatePhaseList(activeIdx) {
  phases.forEach((_, i) => {
    const item = document.getElementById(`phase-item-${i}`);
    if (!item) return;
    if (i < activeIdx) item.className = 'phase-item completed';
    else if (i === activeIdx) item.className = 'phase-item active';
    else item.className = 'phase-item';
  });
}

// â”€â”€â”€ Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearFeed() {
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
}

function addPhaseSeparator(phaseName) {
  const feed = document.getElementById('feed');
  const div = document.createElement('div');
  div.className = 'phase-separator';
  div.innerHTML = `
    <div class="line"></div>
    <div class="label">â–¸ ${phaseName}</div>
    <div class="line"></div>
  `;
  feed.appendChild(div);
  scrollFeed();
}

function addMessage(msg) {
  const feed = document.getElementById('feed');
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  // Process content - basic markdown-like formatting
  const content = msg.content
    .replace(/NEED_HUMAN_INPUT:\s*.+/g, '') // Remove escalation markers from display
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '\n')
    .trim();

  const div = document.createElement('div');
  div.className = 'message';
  div.innerHTML = `
    <div class="message-header">
      <div class="message-badge" style="border-color:${msg.agentColor}40">
        <span class="emoji">${msg.agentEmoji}</span>
        <span style="color:${msg.agentColor}">${msg.agentName}</span>
      </div>
      <span class="message-phase">${msg.phase}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-body" style="border-color:${msg.agentColor}20">${content}</div>
  `;
  feed.appendChild(div);
  scrollFeed();
}

function showThinkingIndicator(agentId) {
  removeThinkingIndicator(agentId);
  const feed = document.getElementById('feed');
  const agent = agents.find(a => a.id === agentId);
  if (!agent) return;

  const div = document.createElement('div');
  div.className = 'thinking-indicator';
  div.id = `thinking-${agentId}`;
  div.innerHTML = `
    <div class="message-badge" style="border-color:${agent.color}40">
      <span class="emoji">${agent.emoji}</span>
      <span style="color:${agent.color}">${agent.name}</span>
    </div>
    <div class="thinking-dots">
      <span></span><span></span><span></span>
    </div>
    <span class="thinking-label">analyzing...</span>
  `;
  feed.appendChild(div);
  scrollFeed();
}

function removeThinkingIndicator(agentId) {
  const el = document.getElementById(`thinking-${agentId}`);
  if (el) el.remove();
}

// â”€â”€â”€ Escalations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addEscalationInline(data) {
  const feed = document.getElementById('feed');
  const agent = agents.find(a => a.id === data.agentId);

  const div = document.createElement('div');
  div.className = 'escalation-card';
  div.id = `esc-inline-${data.id}`;
  div.innerHTML = `
    <div class="esc-header">âš ï¸ Human Input Required â€” ${agent ? agent.name : 'Agent'}</div>
    <div class="esc-question">${data.question}</div>
    <div class="esc-input-row">
      <input type="text" class="esc-input" id="esc-input-${data.id}" placeholder="Type your response...">
      <button class="esc-submit" data-esc-id="${data.id}">Respond</button>
    </div>
  `;
  feed.appendChild(div);
  // Attach event listeners (CSP-safe)
  const escInput = document.getElementById(`esc-input-${data.id}`);
  escInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') respondToEscalation(data.id); });
  div.querySelector('.esc-submit').addEventListener('click', () => respondToEscalation(data.id));
  scrollFeed();
}

function addEscalationToQueue(data) {
  const queue = document.getElementById('escalation-queue');
  // Remove empty message if present
  if (queue.querySelector('span')) queue.innerHTML = '';

  const agent = agents.find(a => a.id === data.agentId);
  const div = document.createElement('div');
  div.className = `escalation-queue-item ${data.answered ? 'answered' : ''}`;
  div.id = `esc-queue-${data.id}`;
  div.innerHTML = `
    <div class="eq-agent">${agent ? agent.emoji : 'â“'} ${agent ? agent.name : 'Agent'}</div>
    <div class="eq-question">${data.question}</div>
  `;
  div.onclick = () => {
    const inlineEl = document.getElementById(`esc-inline-${data.id}`);
    if (inlineEl) inlineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  };
  queue.appendChild(div);
}

function respondToEscalation(escId) {
  const input = document.getElementById(`esc-input-${escId}`);
  if (!input || !input.value.trim()) return;

  const answer = input.value.trim();

  ws.send(JSON.stringify({
    type: 'escalation-response',
    sessionId: currentSession.id,
    escalationId: escId,
    answer: answer
  }));
}

function markEscalationAnswered(escId, answer) {
  // Update inline card
  const inline = document.getElementById(`esc-inline-${escId}`);
  if (inline) {
    inline.classList.add('answered');
    const inputRow = inline.querySelector('.esc-input-row');
    if (inputRow) {
      inputRow.innerHTML = `<div class="esc-answer">âœ… Your response: ${answer}</div>`;
    }
    inline.querySelector('.esc-header').textContent = 'âœ… Answered';
  }

  // Update queue
  const queueItem = document.getElementById(`esc-queue-${escId}`);
  if (queueItem) queueItem.classList.add('answered');
}

function addCompleteBanner() {
  const feed = document.getElementById('feed');
  const div = document.createElement('div');
  div.className = 'complete-banner';
  div.innerHTML = `
    <h3>âœ… Deliberation Complete</h3>
    <p>All phases finished. Review the synthesis above for findings and recommendations.</p>
  `;
  feed.appendChild(div);
  scrollFeed();
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitProblem() {
  const input = document.getElementById('main-input');
  const problem = input.value.trim();
  if (!problem) return;
  if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('âš ï¸ Not connected â€” reconnecting...'); connect(); return; }

  try {
    ws.send(JSON.stringify({ type: 'new-session', problem }));
    input.value = '';
  } catch(err) {
    console.error('Submit failed:', err);
    showToast('âš ï¸ Submit failed: ' + err.message);
  }
}

async function submitFromWelcome() {
  try {
    const textarea = document.getElementById('welcome-input');
    let problem = textarea.value.trim();
    if (!problem && pendingFiles.length === 0) { showToast('âš ï¸ Please describe a problem or attach a file'); return; }
    if (!problem && pendingFiles.length > 0) { problem = 'Analyze the attached file(s) and provide a comprehensive research deliberation.'; }
    if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('âš ï¸ Not connected â€” reconnecting...'); connect(); return; }

    const btn = document.getElementById('welcome-submit');
    btn.disabled = true;
    btn.textContent = 'â³ Uploading...';

    // Upload files first
    const files = await uploadFiles();

    btn.textContent = 'âš¡ Deploying...';
    ws.send(JSON.stringify({ type: 'new-session', problem, files }));
    textarea.value = '';
    pendingFiles = [];
    renderFileList();
    btn.disabled = false;
    btn.textContent = 'âš¡ Deploy War Room';
  } catch(err) {
    console.error('Deploy failed:', err);
    showToast('âš ï¸ Deploy failed: ' + err.message);
    const btn = document.getElementById('welcome-submit');
    if (btn) { btn.disabled = false; btn.textContent = 'âš¡ Deploy War Room'; }
  }
}

function stopSession() {
  if (!currentSession || !ws || ws.readyState !== WebSocket.OPEN) return;
  try { ws.send(JSON.stringify({ type: 'stop-session', sessionId: currentSession.id })); } catch(e) { console.error('Stop failed:', e); }
}

function scrollFeed() {
  const feed = document.getElementById('feed');
  requestAnimationFrame(() => {
    feed.scrollTop = feed.scrollHeight;
  });
}

// â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRightPanel() {
  const panel = document.getElementById('right-panel');
  const toggle = document.getElementById('right-panel-toggle');
  panel.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
  toggle.textContent = panel.classList.contains('collapsed') ? 'â–¸' : 'â—‚';
}

function toggleMobileSidebar() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 4000);
}

function startDurationTimer() {
  stopDurationTimer();
  durationInterval = setInterval(() => {
    if (!sessionStart) return;
    const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    document.getElementById('info-duration').textContent = `${mins}m ${secs}s`;
  }, 1000);
}

function stopDurationTimer() {
  if (durationInterval) clearInterval(durationInterval);
}

// â”€â”€â”€ Input handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('main-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    submitProblem();
  }
});

document.getElementById('human-chat-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendHumanMessage();
  }
});

// â”€â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  files.forEach(addFile);
  event.target.value = '';
}

function addFile(file) {
  if (file.size > 10 * 1024 * 1024) {
    showToast(`âš ï¸ ${file.name} too large (max 10MB)`);
    return;
  }
  pendingFiles.push(file);
  renderFileList();
}

function removeFile(idx) {
  pendingFiles.splice(idx, 1);
  renderFileList();
}

function renderFileList() {
  const list = document.getElementById('file-list');
  if (pendingFiles.length === 0) {
    list.innerHTML = '';
    return;
  }
  list.innerHTML = pendingFiles.map((f, i) => {
    const size = f.size < 1024 ? f.size + 'B' : (f.size / 1024).toFixed(1) + 'KB';
    return `<div class="file-chip">ğŸ“„ ${f.name} (${size}) <span class="remove-file" data-idx="${i}">Ã—</span></div>`;
  }).join('');
  list.querySelectorAll('.remove-file').forEach(el => {
    el.addEventListener('click', () => removeFile(parseInt(el.dataset.idx)));
  });
}

// Drag and drop on the file zone
const dropZone = document.getElementById('file-drop-zone');
if (dropZone) {
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    Array.from(e.dataTransfer.files).forEach(addFile);
  });
}

async function uploadFiles() {
  if (pendingFiles.length === 0) return [];
  const formData = new FormData();
  pendingFiles.forEach(f => formData.append('files', f));
  try {
    const res = await fetch(apiUrl('/api/upload'), { method: 'POST', body: formData });
    if (!res.ok) {
      console.error('Upload HTTP error:', res.status, res.statusText);
      showToast(`âš ï¸ Upload failed (${res.status})`);
      return [];
    }
    const data = await res.json();
    console.log('Upload result:', data);
    return data.files || [];
  } catch(e) {
    console.error('Upload exception:', e);
    showToast('âš ï¸ File upload failed: ' + e.message);
    return [];
  }
}

// â”€â”€â”€ Human Chat During Deliberation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendHumanMessage() {
  const input = document.getElementById('human-chat-input');
  const content = input.value.trim();
  if (!content || !currentSession) return;
  if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('âš ï¸ Not connected'); return; }

  try {
    ws.send(JSON.stringify({ type: 'human-message', sessionId: currentSession.id, content }));
    input.value = '';
  } catch(e) { console.error('Send failed:', e); showToast('âš ï¸ Send failed'); }
}

function addHumanMessageToFeed(data) {
  const feed = document.getElementById('feed');
  const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const div = document.createElement('div');
  div.className = 'message human-msg';
  div.innerHTML = `
    <div class="message-header">
      <div class="message-badge">
        <span class="emoji">ğŸ‘¤</span>
        <span style="color:var(--green)">You (Human)</span>
      </div>
      <span class="message-phase">Interjection</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-body">${data.content}</div>
  `;
  feed.appendChild(div);
  scrollFeed();
}

// â”€â”€â”€ Event Listeners (CSP-safe, no inline handlers) â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('mobile-toggle-btn').addEventListener('click', toggleMobileSidebar);
document.getElementById('file-input').addEventListener('change', handleFileSelect);
document.getElementById('welcome-submit').addEventListener('click', submitFromWelcome);
document.getElementById('human-send-btn').addEventListener('click', sendHumanMessage);
document.getElementById('stop-session-btn').addEventListener('click', stopSession);
document.getElementById('submit-btn').addEventListener('click', submitProblem);
document.getElementById('right-panel-toggle').addEventListener('click', toggleRightPanel);

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect();
</script>
</body>
</html>
