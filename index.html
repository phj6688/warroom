<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>War Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green: #00ff41;
  --green-dim: #00cc33;
  --green-dark: #004d13;
  --green-glow: rgba(0, 255, 65, 0.3);
  --bg: #000000;
  --bg-panel: rgba(0, 20, 5, 0.92);
  --bg-card: rgba(0, 40, 10, 0.6);
  --border: rgba(0, 255, 65, 0.12);
  --border-bright: rgba(0, 255, 65, 0.35);
  --text: #00ff41;
  --text-dim: rgba(0, 255, 65, 0.6);
  --text-dimmer: rgba(0, 255, 65, 0.35);
  --danger: #ff4141;
  --warning: #ffaa00;
  --font: 'JetBrains Mono', monospace;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --radius: 14px;
  --transition: cubic-bezier(.32,.72,0,1);
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: 13px;
  line-height: 1.5;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

::-webkit-scrollbar { display: none; }
* { scrollbar-width: none; }

/* â”€â”€â”€ Matrix Rain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#matrix-rain {
  position: fixed; inset: 0;
  z-index: 0; opacity: 0.05;
  pointer-events: none;
}

/* â”€â”€â”€ Scanlines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scanlines {
  position: fixed; inset: 0;
  z-index: 9999; pointer-events: none;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.12) 0px, rgba(0,0,0,0.12) 1px, transparent 1px, transparent 3px);
}

/* â”€â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh;
  position: relative;
  z-index: 1;
}

/* â”€â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top-bar {
  display: flex;
  align-items: center;
  padding: 0 16px;
  padding-top: var(--safe-top);
  height: calc(56px + var(--safe-top));
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  gap: 12px;
  flex-shrink: 0;
  z-index: 20;
}

.top-bar .logo {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  white-space: nowrap;
  text-shadow: 0 0 10px var(--green-glow);
}

.top-bar .problem-display {
  flex: 1;
  font-size: 11px;
  color: var(--text-dim);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  min-width: 0;
}

.status-badge {
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  white-space: nowrap;
  flex-shrink: 0;
}
.status-badge.active { background: rgba(0,255,65,0.15); border: 1px solid var(--green-dim); color: var(--green); }
.status-badge.idle { background: rgba(0,255,65,0.05); border: 1px solid var(--border); color: var(--text-dim); }

.top-btn {
  width: 44px; height: 44px;
  display: flex; align-items: center; justify-content: center;
  background: none; border: 1px solid var(--border);
  border-radius: 10px; color: var(--text-dim);
  font-size: 18px; cursor: pointer;
  transition: all 0.2s var(--transition);
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}
.top-btn:active { transform: scale(0.93); background: var(--bg-card); }
.top-btn.has-badge { position: relative; }
.top-btn .badge-dot {
  position: absolute; top: 8px; right: 8px;
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--danger);
  box-shadow: 0 0 6px rgba(255,65,65,0.5);
}

/* â”€â”€â”€ Views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view { display: none; flex: 1; overflow: hidden; flex-direction: column; min-height: 0; }
.view.active { display: flex; }

/* â”€â”€â”€ Welcome View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.welcome-view {
  padding: 24px 16px;
  padding-bottom: calc(16px + var(--safe-bottom));
  overflow-y: auto;
  justify-content: center;
  align-items: center;
}

.welcome-view h1 {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow: 0 0 20px var(--green-glow);
  text-align: center;
  margin-bottom: 8px;
}

.welcome-view .subtitle {
  font-size: 12px;
  color: var(--text-dim);
  text-align: center;
  max-width: 500px;
  margin-bottom: 28px;
  line-height: 1.6;
}

.welcome-input-area { width: 100%; max-width: 600px; }

.welcome-textarea {
  width: 100%;
  min-height: 120px;
  padding: 16px;
  background: rgba(0,20,5,0.9);
  border: 1px solid var(--border-bright);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.6;
  resize: vertical;
  outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.welcome-textarea:focus {
  border-color: var(--green);
  box-shadow: 0 0 20px rgba(0,255,65,0.1);
}
.welcome-textarea::placeholder { color: var(--text-dimmer); }

.file-drop-zone {
  margin-top: 14px;
  padding: 18px;
  border: 2px dashed var(--border-bright);
  border-radius: var(--radius);
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  color: var(--text-dimmer);
  font-size: 12px;
  position: relative;
  min-height: 44px;
}
.file-drop-zone:hover, .file-drop-zone.dragover {
  border-color: var(--green);
  background: rgba(0,255,65,0.05);
}
.file-drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

.file-list {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.file-chip {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 12px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 8px; font-size: 11px; color: var(--text-dim);
}
.file-chip .remove-file { cursor: pointer; color: var(--danger); font-size: 14px; min-width: 20px; min-height: 20px; display: flex; align-items: center; justify-content: center; }

.welcome-submit {
  margin-top: 16px;
  width: 100%;
  padding: 16px;
  background: rgba(0,255,65,0.15);
  border: 1px solid var(--green-dim);
  border-radius: var(--radius);
  color: var(--green);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s var(--transition);
  min-height: 52px;
  text-shadow: 0 0 8px var(--green-glow);
}
.welcome-submit:hover { background: rgba(0,255,65,0.22); }
.welcome-submit:active { transform: scale(0.97); }
.welcome-submit:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* â”€â”€â”€ Session History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.session-list {
  margin-top: 28px;
  width: 100%;
  max-width: 600px;
}
.session-list-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-dim);
  margin-bottom: 10px;
}
.session-item {
  padding: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s var(--transition);
  min-height: 44px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.session-item:active { transform: scale(0.97); background: rgba(0,255,65,0.08); }
.session-item .si-status {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}
.session-item .si-status.active { background: var(--green); box-shadow: 0 0 6px var(--green-glow); }
.session-item .si-status.done { background: var(--text-dimmer); }
.session-item .si-info { flex: 1; min-width: 0; }
.session-item .si-problem { font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.session-item .si-meta { font-size: 10px; color: var(--text-dimmer); margin-top: 2px; }
.session-item .si-delete {
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid rgba(255,65,65,0.2); border-radius: 8px;
  background: none; color: var(--danger); font-size: 14px;
  cursor: pointer; flex-shrink: 0; opacity: 0.5;
  transition: all 0.2s;
}
.session-item .si-delete:hover { opacity: 1; background: rgba(255,65,65,0.1); }
.session-item .si-delete:active { transform: scale(0.9); }
.session-list-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.session-list-header .clear-all {
  font-size: 11px; color: var(--danger); opacity: 0.6;
  cursor: pointer; background: none; border: none;
  font-family: var(--font); padding: 6px 10px;
  border-radius: 6px; transition: all 0.2s;
}
.session-list-header .clear-all:hover { opacity: 1; background: rgba(255,65,65,0.1); }

/* â”€â”€â”€ Deliberation View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.deliberation-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}

.feed-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
  min-height: 0;
}

.feed {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  padding-left: calc(16px + var(--safe-left));
  padding-right: calc(16px + var(--safe-right));
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  min-height: 0;
}

/* Phase Separator */
.phase-separator {
  display: flex; align-items: center;
  margin: 20px 0; gap: 12px;
  animation: fadeSlideIn 0.4s var(--transition);
}
.phase-separator .line { flex: 1; height: 1px; background: linear-gradient(90deg, transparent, var(--border-bright), transparent); }
.phase-separator .label {
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px;
  color: var(--green);
  padding: 5px 14px;
  border: 1px solid var(--border-bright);
  border-radius: 16px;
  background: var(--bg-card);
  text-shadow: 0 0 8px var(--green-glow);
  white-space: nowrap;
}

/* Message */
.message {
  margin-bottom: 14px;
  animation: fadeSlideIn 0.35s var(--transition);
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 5px;
}
.message-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 8px;
  border-radius: 6px; font-size: 11px; font-weight: 600;
  border: 1px solid var(--border);
  background: var(--bg-card);
}
.message-badge .emoji { font-size: 13px; }
.message-phase { font-size: 9px; color: var(--text-dimmer); margin-left: auto; }
.message-time { font-size: 9px; color: var(--text-dimmer); }

.message-body {
  padding: 12px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 13px;
  line-height: 1.7;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.message-body strong, .message-body b { color: var(--green); font-weight: 600; }

/* Copy button */
.message-body { position: relative; }
.copy-btn {
  position: absolute; top: 6px; right: 6px;
  background: rgba(0, 40, 10, 0.85); border: 1px solid var(--border);
  color: var(--text-dim); cursor: pointer; border-radius: 5px;
  padding: 4px 7px; font-size: 11px; font-family: var(--font);
  opacity: 0; transition: opacity 0.2s, color 0.2s, border-color 0.2s;
  z-index: 2; line-height: 1;
}
.message-body:hover .copy-btn, .copy-btn:focus { opacity: 1; }
.copy-btn:active { transform: scale(0.93); }
.copy-btn.copied { color: var(--green); border-color: var(--green-dim); }
@media (hover: none) { .copy-btn { opacity: 0.7; } }

/* Human message */
.message.human-msg .message-body { background: rgba(0,255,65,0.06); border-color: var(--green-dim); }
.message.human-msg .message-badge { border-color: var(--green-dim); }

/* Escalation inline */
.escalation-card {
  margin: 14px 0; padding: 14px;
  background: rgba(255,65,65,0.08);
  border: 1px solid rgba(255,65,65,0.3);
  border-radius: var(--radius);
  animation: esc-glow 2s ease-in-out infinite;
}
@keyframes esc-glow {
  0%, 100% { box-shadow: 0 0 8px rgba(255,65,65,0.1); }
  50% { box-shadow: 0 0 20px rgba(255,65,65,0.15); }
}
.escalation-card.answered { animation: none; border-color: rgba(0,255,65,0.3); background: rgba(0,255,65,0.05); }
.escalation-card .esc-header {
  display: flex; align-items: center; gap: 6px;
  font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
  color: var(--danger); margin-bottom: 8px;
}
.escalation-card.answered .esc-header { color: var(--green); }
.escalation-card .esc-question { font-size: 12px; margin-bottom: 10px; }
.escalation-card .esc-input-row { display: flex; gap: 8px; }
.escalation-card .esc-input {
  flex: 1;
  background: rgba(0,0,0,0.5); border: 1px solid rgba(255,65,65,0.3);
  border-radius: 10px; padding: 10px 12px;
  color: var(--text); font-family: var(--font); font-size: 12px;
  outline: none; min-height: 44px;
}
.escalation-card .esc-input:focus { border-color: var(--green); }
.escalation-card .esc-submit {
  padding: 10px 16px;
  background: rgba(0,255,65,0.15); border: 1px solid var(--green-dim);
  border-radius: 10px; color: var(--green);
  font-family: var(--font); font-size: 12px; font-weight: 600;
  cursor: pointer; min-height: 44px; min-width: 44px;
  transition: all 0.2s;
}
.escalation-card .esc-submit:active { transform: scale(0.95); }
.escalation-card .esc-dismiss { background: none; border: 1px solid rgba(255,165,0,0.3); color: var(--amber, #ffa500); font-size: 11px; padding: 2px 10px; border-radius: 4px; cursor: pointer; margin-left: auto; }
.escalation-card .esc-dismiss:hover { border-color: rgba(255,165,0,0.6); background: rgba(255,165,0,0.1); }
.escalation-card.dismissed { max-height: 0; overflow: hidden; padding: 0; margin: 0; border: none; opacity: 0; transition: all 0.3s ease; }
.escalation-card .esc-header-row { display: flex; align-items: center; gap: 8px; }
.escalation-card .esc-answer {
  margin-top: 8px; padding: 8px 12px;
  background: rgba(0,255,65,0.08); border-radius: 8px;
  font-size: 12px; color: var(--green);
}

/* Thinking indicator */
.thinking-indicator {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; margin-bottom: 14px;
  animation: fadeSlideIn 0.3s;
  min-height: 44px;
}
.thinking-spinner {
  position: relative; width: 28px; height: 28px; flex-shrink: 0;
}
.thinking-spinner-ring {
  width: 28px; height: 28px; border-radius: 50%;
  border: 2px solid rgba(0,255,65,0.1);
  border-top-color: var(--green);
  animation: spin 0.8s linear infinite;
  box-shadow: 0 0 8px rgba(0,255,65,0.15);
}
.thinking-spinner-core {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  animation: core-pulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 6px var(--green-glow);
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes core-pulse {
  0%, 100% { opacity: 0.4; transform: translate(-50%,-50%) scale(0.8); }
  50% { opacity: 1; transform: translate(-50%,-50%) scale(1.2); }
}
.thinking-text {
  display: flex; flex-direction: column; gap: 2px; min-width: 0;
}
.thinking-label { font-size: 10px; color: var(--text-dim); font-style: italic; }
.thinking-chars {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: var(--green-dim); letter-spacing: 2px; overflow: hidden;
  white-space: nowrap; max-width: 140px;
  animation: matrix-scroll 3s linear infinite;
}
@keyframes matrix-scroll {
  0% { opacity: 0.3; }
  50% { opacity: 0.7; }
  100% { opacity: 0.3; }
}

/* Complete banner */
.complete-banner {
  text-align: center; padding: 18px; margin: 18px 0;
  border: 1px solid var(--border-bright); border-radius: var(--radius);
  background: rgba(0,255,65,0.05); animation: fadeSlideIn 0.5s;
}
.complete-banner h3 { font-size: 13px; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 10px var(--green-glow); margin-bottom: 4px; }
.complete-banner p { font-size: 11px; color: var(--text-dim); }

/* â”€â”€â”€ Chat Input Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-bar {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 16px;
  padding-bottom: calc(10px + var(--safe-bottom));
  padding-left: calc(16px + var(--safe-left));
  padding-right: calc(16px + var(--safe-right));
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  flex-shrink: 0;
}
.chat-bar input {
  flex: 1;
  padding: 12px 16px;
  background: rgba(0,20,5,0.8);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text); font-family: var(--font); font-size: 13px;
  outline: none; min-height: 44px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.chat-bar input:focus { border-color: var(--green-dim); box-shadow: 0 0 12px rgba(0,255,65,0.08); }
.chat-bar input::placeholder { color: var(--text-dimmer); }

.chat-bar-btn {
  width: 44px; height: 44px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 12px; font-size: 16px;
  cursor: pointer; transition: all 0.2s var(--transition);
  flex-shrink: 0; border: none;
}
.chat-bar-btn:active { transform: scale(0.93); }

.send-btn { background: rgba(0,255,65,0.15); border: 1px solid var(--green-dim); color: var(--green); }
.stop-btn { background: rgba(255,65,65,0.15); border: 1px solid rgba(255,65,65,0.4); color: var(--danger); }

/* â”€â”€â”€ Bottom Sheet (Agents / Phases / Escalations) â”€â”€â”€â”€ */
.sheet-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
.sheet-overlay.open { opacity: 1; pointer-events: auto; }

.bottom-sheet {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  max-height: 70vh;
  background: var(--bg-panel);
  border-top: 1px solid var(--border-bright);
  border-radius: 20px 20px 0 0;
  z-index: 51;
  transform: translateY(100%);
  transition: transform 0.35s var(--transition);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: var(--safe-bottom);
}
.bottom-sheet.open { transform: translateY(0); }

.sheet-handle {
  display: flex; justify-content: center;
  padding: 12px 0 8px;
  cursor: pointer;
}
.sheet-handle::after {
  content: '';
  width: 36px; height: 4px;
  background: var(--text-dimmer); border-radius: 2px;
}

.sheet-title {
  font-size: 12px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px;
  color: var(--text-dim);
  padding: 0 20px 12px;
}

.sheet-content { padding: 0 16px 16px; }

/* Agent cards in sheet */
.sheet-agent {
  display: flex; align-items: center;
  padding: 12px; border-radius: 12px;
  margin-bottom: 6px;
  border: 1px solid transparent;
  transition: all 0.2s;
  min-height: 44px;
}
.sheet-agent.thinking { background: rgba(0,255,65,0.06); border-color: var(--border-bright); }
.sheet-agent.speaking { background: rgba(0,255,65,0.1); border-color: var(--green-dim); }

.sa-emoji {
  font-size: 20px; width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 10px; background: var(--bg-card);
  margin-right: 12px; flex-shrink: 0;
}
.sa-info { flex: 1; min-width: 0; }
.sa-name { font-size: 12px; font-weight: 600; }
.sa-role { font-size: 10px; color: var(--text-dimmer); }
.sa-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--text-dimmer); flex-shrink: 0; margin-left: 8px;
  transition: all 0.3s;
}
.sa-dot.thinking { background: var(--green); box-shadow: 0 0 8px var(--green-glow); animation: pulse 1s infinite; }
.sa-dot.speaking { background: var(--green); box-shadow: 0 0 6px var(--green-glow); animation: pulse 1s infinite; }
.sa-dot.searching { background: #41a0ff; box-shadow: 0 0 6px rgba(65,160,255,0.5); animation: pulse 1.2s infinite; }
.sheet-agent.searching { background: rgba(65,160,255,0.08); border-color: rgba(65,160,255,0.3); }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); opacity: 0.7; } }

/* Phase items in sheet */
.sheet-phase {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 4px; font-size: 12px; color: var(--text-dimmer);
}
.sheet-phase.active { color: var(--green); }
.sheet-phase.completed { color: var(--text-dim); }
.sp-dot {
  width: 10px; height: 10px; border-radius: 50%;
  border: 2px solid var(--text-dimmer); flex-shrink: 0;
}
.sheet-phase.active .sp-dot { border-color: var(--green); background: var(--green); box-shadow: 0 0 8px var(--green-glow); }
.sheet-phase.completed .sp-dot { border-color: var(--green-dim); background: var(--green-dim); }

/* Escalation items in sheet */
.sheet-esc {
  padding: 12px; background: var(--bg-card);
  border: 1px solid rgba(255,65,65,0.2);
  border-radius: 10px; margin-bottom: 8px;
  font-size: 11px; cursor: pointer;
  min-height: 44px; transition: all 0.2s;
}
.sheet-esc:active { transform: scale(0.97); }
.sheet-esc.answered { border-color: rgba(0,255,65,0.2); opacity: 0.7; }
.sheet-esc .se-agent { font-weight: 600; margin-bottom: 3px; }
.sheet-esc .se-question { color: var(--text-dim); }

/* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  top: calc(60px + var(--safe-top));
  left: 50%; transform: translateX(-50%) translateY(-10px);
  z-index: 100;
  padding: 10px 18px;
  background: rgba(255,65,65,0.15);
  border: 1px solid rgba(255,65,65,0.4);
  border-radius: 12px;
  color: var(--danger); font-size: 12px; font-weight: 600;
  backdrop-filter: blur(10px);
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s, transform 0.3s var(--transition);
  max-width: calc(100vw - 32px);
  text-align: center;
}
.toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

/* â”€â”€â”€ Command Palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cmd-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  display: none; align-items: flex-start; justify-content: center;
  padding-top: calc(80px + var(--safe-top));
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.cmd-overlay.open { display: flex; }

.cmd-palette {
  width: 90vw; max-width: 560px;
  background: var(--bg-panel);
  border: 1px solid var(--border-bright);
  border-radius: var(--radius);
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 40px rgba(0,255,65,0.08);
  overflow: hidden;
  animation: cmdSlideIn 0.2s var(--transition);
}
@keyframes cmdSlideIn {
  from { opacity: 0; transform: translateY(-12px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.cmd-input-wrap {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}
.cmd-input-wrap .cmd-icon { font-size: 16px; color: var(--text-dim); flex-shrink: 0; }
.cmd-input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font); font-size: 14px;
}
.cmd-input::placeholder { color: var(--text-dimmer); }
.cmd-kbd {
  font-size: 10px; color: var(--text-dimmer);
  background: var(--bg-card); border: 1px solid var(--border);
  padding: 2px 6px; border-radius: 4px; flex-shrink: 0;
}

.cmd-results {
  max-height: 340px; overflow-y: auto;
  padding: 6px 0;
}
.cmd-results:empty::after {
  content: 'Type to search sessions or use a command...';
  display: block; padding: 20px 16px; text-align: center;
  font-size: 12px; color: var(--text-dimmer);
}

.cmd-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px; cursor: pointer;
  transition: background 0.1s;
  min-height: 44px;
}
.cmd-item:hover, .cmd-item.selected { background: rgba(0,255,65,0.08); }
.cmd-item .cmd-item-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
.cmd-item .cmd-item-info { flex: 1; min-width: 0; }
.cmd-item .cmd-item-title { font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cmd-item .cmd-item-meta { font-size: 10px; color: var(--text-dimmer); margin-top: 1px; }
.cmd-item .cmd-item-badge {
  font-size: 9px; padding: 2px 6px; border-radius: 4px;
  background: var(--bg-card); border: 1px solid var(--border);
  color: var(--text-dim); flex-shrink: 0;
}

.cmd-footer {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 16px; border-top: 1px solid var(--border);
  font-size: 10px; color: var(--text-dimmer);
}
.cmd-footer kbd {
  font-family: var(--font); background: var(--bg-card);
  border: 1px solid var(--border); padding: 1px 5px;
  border-radius: 3px; font-size: 10px;
}

/* â”€â”€â”€ Desktop Enhancements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (min-width: 768px) {
  .deliberation-view { flex-direction: row; }
  .desktop-sidebar {
    width: 260px; flex-shrink: 0;
    background: var(--bg-panel);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    display: flex; flex-direction: column;
  }
  .desktop-sidebar .ds-header {
    padding: 16px; border-bottom: 1px solid var(--border);
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 2px; color: var(--text-dim);
  }
  .desktop-sidebar .ds-agents { padding: 8px; flex: 1; }
  .desktop-right {
    width: 280px; flex-shrink: 0;
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    display: flex; flex-direction: column;
  }
  .desktop-right .dr-section {
    padding: 16px; border-bottom: 1px solid var(--border);
  }
  .desktop-right .dr-title {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 2px; color: var(--text-dim); margin-bottom: 10px;
  }
  .feed { padding: 20px; }
  .top-btn.mobile-only { display: none; }
}

@media (max-width: 767px) {
  .desktop-sidebar, .desktop-right { display: none !important; }
}
</style>
</head>
<body>
<canvas id="matrix-rain"></canvas>
<div class="scanlines"></div>

<div class="app">
  <!-- Top Bar -->
  <div class="top-bar">
    <button class="top-btn" id="btn-back" title="Back to sessions" style="display:none">â†</button>
    <button class="top-btn mobile-only" id="btn-agents" title="Agents">ğŸ‘¥</button>
    <div class="logo">âš¡ War Room</div>
    <div class="problem-display" id="problem-display"></div>
    <div class="status-badge idle" id="status-badge">Idle</div>
    <button class="top-btn mobile-only" id="btn-phases" title="Phases">ğŸ“Š</button>
    <button class="top-btn mobile-only has-badge" id="btn-escalations" title="Escalations">
      ğŸ”´
      <span class="badge-dot" id="esc-badge" style="display:none"></span>
    </button>
  </div>

  <!-- Welcome View -->
  <div class="view active" id="view-welcome">
    <div class="welcome-view">
      <h1>War Room</h1>
      <div class="subtitle">8 cognitive agents deliberate through 5 phases to solve complex problems.</div>
      <div class="welcome-input-area">
        <textarea class="welcome-textarea" id="welcome-input" placeholder="Describe a complex problem, strategic question, or research challenge..."></textarea>
        <div class="file-drop-zone" id="file-drop-zone">
          ğŸ“ Drop files or tap to attach (max 10MB each)
          <input type="file" id="file-input" multiple>
        </div>
        <div class="file-list" id="file-list"></div>
        <button class="welcome-submit" id="welcome-submit">âš¡ Deploy War Room</button>
      </div>
      <div class="session-list" id="session-list-container" style="display:none">
        <div class="session-list-header">
          <div class="session-list-title" style="margin-bottom:0">Session History</div>
          <button class="clear-all" id="clear-all-sessions">Clear All</button>
        </div>
        <div id="session-list"></div>
      </div>
    </div>
  </div>

  <!-- Deliberation View -->
  <div class="view" id="view-deliberation">
    <div class="deliberation-view">
      <!-- Desktop Sidebar -->
      <div class="desktop-sidebar" id="desktop-sidebar">
        <div class="ds-header">Agents</div>
        <div class="ds-agents" id="desktop-agent-list"></div>
      </div>

      <!-- Feed -->
      <div class="feed-column">
        <div class="feed" id="feed"></div>
        <div class="chat-bar" id="chat-bar">
          <input type="text" id="chat-input" placeholder="Add context, answer questions..." autocomplete="off">
          <button class="chat-bar-btn send-btn" id="btn-send" title="Send">â–¸</button>
          <button class="chat-bar-btn stop-btn" id="btn-stop" title="Stop">â– </button>
        </div>
      </div>

      <!-- Desktop Right Panel -->
      <div class="desktop-right" id="desktop-right">
        <div class="dr-section">
          <div class="dr-title">Phase Progress</div>
          <div id="desktop-phases"></div>
        </div>
        <div class="dr-section">
          <div class="dr-title">Escalations</div>
          <div id="desktop-escalations"><span style="font-size:11px;color:var(--text-dimmer)">None yet</span></div>
        </div>
        <div class="dr-section">
          <div class="dr-title">Session</div>
          <div id="desktop-session-info">
            <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px"><span style="color:var(--text-dimmer)">Messages</span><span id="info-messages">0</span></div>
            <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px"><span style="color:var(--text-dimmer)">Escalations</span><span id="info-escalations">0</span></div>
            <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px"><span style="color:var(--text-dimmer)">Duration</span><span id="info-duration">â€”</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Sheets (mobile) -->
<div class="sheet-overlay" id="sheet-overlay"></div>

<div class="bottom-sheet" id="sheet-agents">
  <div class="sheet-handle" id="sheet-agents-handle"></div>
  <div class="sheet-title">Agents</div>
  <div class="sheet-content" id="sheet-agent-list"></div>
</div>

<div class="bottom-sheet" id="sheet-phases">
  <div class="sheet-handle" id="sheet-phases-handle"></div>
  <div class="sheet-title">Phase Progress</div>
  <div class="sheet-content" id="sheet-phase-list"></div>
</div>

<div class="bottom-sheet" id="sheet-escalations">
  <div class="sheet-handle" id="sheet-escalations-handle"></div>
  <div class="sheet-title">Escalation Queue</div>
  <div class="sheet-content" id="sheet-esc-list"></div>
</div>

<!-- Command Palette -->
<div class="cmd-overlay" id="cmd-overlay">
  <div class="cmd-palette">
    <div class="cmd-input-wrap">
      <span class="cmd-icon">âš¡</span>
      <input type="text" class="cmd-input" id="cmd-input" placeholder="Search sessions, commands..." autocomplete="off" spellcheck="false">
      <span class="cmd-kbd">ESC</span>
    </div>
    <div class="cmd-results" id="cmd-results"></div>
    <div class="cmd-footer">
      <span><kbd>â†‘â†“</kbd> navigate</span>
      <span><kbd>â†µ</kbd> open</span>
      <span><kbd>esc</kbd> close</span>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ Matrix Rain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('matrix-rain');
const ctx = canvas.getContext('2d');
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const chars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½0123456789ABCDEF';
const fontSize = 14;
let columns = Math.floor(canvas.width / fontSize);
let drops = Array(columns).fill(1);

function drawMatrix() {
  ctx.fillStyle = 'rgba(0,0,0,0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#00ff41';
  ctx.font = fontSize + 'px monospace';
  for (let i = 0; i < drops.length; i++) {
    ctx.fillText(chars[Math.floor(Math.random() * chars.length)], i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 50);
window.addEventListener('resize', () => { columns = Math.floor(canvas.width / fontSize); drops = Array(columns).fill(1); });

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null;
let agents = [];
let phases = [];
let currentSession = null;
let sessionsList = [];
let messageCount = 0;
let escalationCount = 0;
let pendingEscalations = 0;
let sessionStart = null;
let durationInterval = null;
let pendingFiles = [];
let activeSheet = null;

const BASE_PATH = (() => { const m = location.pathname.match(/^(\/proxy\/[^/]+)/); return m ? m[1] : ''; })();
function apiUrl(p) { return BASE_PATH + p; }

// â”€â”€â”€ Views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('btn-back').style.display = id === 'view-deliberation' ? 'flex' : 'none';
}

// â”€â”€â”€ Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheet(id) {
  closeSheet();
  activeSheet = id;
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById(id).classList.add('open');
}
function closeSheet() {
  if (activeSheet) {
    document.getElementById(activeSheet).classList.remove('open');
    activeSheet = null;
  }
  document.getElementById('sheet-overlay').classList.remove('open');
}

document.getElementById('sheet-overlay').addEventListener('click', closeSheet);
document.getElementById('sheet-agents-handle').addEventListener('click', closeSheet);
document.getElementById('sheet-phases-handle').addEventListener('click', closeSheet);
document.getElementById('sheet-escalations-handle').addEventListener('click', closeSheet);

document.getElementById('btn-agents').addEventListener('click', () => openSheet('sheet-agents'));
document.getElementById('btn-phases').addEventListener('click', () => openSheet('sheet-phases'));
document.getElementById('btn-escalations').addEventListener('click', () => { openSheet('sheet-escalations'); pendingEscalations = 0; document.getElementById('esc-badge').style.display = 'none'; });

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getWsUrl() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  return `${proto}//${location.host}${BASE_PATH}`;
}

function connect() {
  ws = new WebSocket(getWsUrl());
  ws.onopen = () => console.log('Connected');
  ws.onclose = () => { console.log('Disconnected'); setTimeout(connect, 3000); };
  ws.onerror = (e) => console.error('WS error:', e);
  ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
}

function handleMessage(data) {
  switch (data.type) {
    case 'agents':
      agents = data.agents;
      renderAgents();
      break;

    case 'phases':
      phases = data.phases;
      renderPhases();
      break;

    case 'sessions':
      sessionsList = data.sessions || [];
      renderSessionList();
      break;

    case 'session-created':
      currentSession = data.session;
      sessionStart = Date.now();
      messageCount = 0; escalationCount = 0; pendingEscalations = 0;
      showView('view-deliberation');
      document.getElementById('problem-display').textContent = data.session.problem;
      document.getElementById('status-badge').textContent = 'Active';
      document.getElementById('status-badge').className = 'status-badge active';
      clearFeed();
      startDurationTimer();
      break;

    case 'phase-change':
      updatePhases(data.phase);
      addPhaseSeparator(data.phaseName);
      break;

    case 'agent-state':
      updateAgentState(data.agentId, data.state);
      if (data.state === 'thinking') showThinking(data.agentId);
      else removeThinking(data.agentId);
      break;

    case 'message':
      removeThinking(data.agentId);
      addMessage(data);
      messageCount++;
      document.getElementById('info-messages').textContent = messageCount;
      break;

    case 'escalation':
      addEscalationInline(data);
      addEscalationToQueue(data);
      escalationCount++;
      pendingEscalations++;
      document.getElementById('info-escalations').textContent = escalationCount;
      document.getElementById('esc-badge').style.display = 'block';
      showToast(`ğŸ”´ ${data.agentName} needs input!`);
      break;

    case 'escalation-answered':
      markEscalationAnswered(data.escalationId, data.answer);
      break;

    case 'waiting-for-human':
      showToast(`â³ Waiting for ${data.pendingCount} response(s)...`);
      break;

    case 'escalation-timeout':
      showToast('â° Proceeding without input');
      break;

    case 'search-started':
      showToast(`ğŸ” Research Scout searching (${data.queries.length} queries)...`);
      addSearchIndicator(data.queries);
      break;

    case 'search-complete': {
      const si = document.getElementById('search-indicator');
      if (si) si.remove();
      showToast(`ğŸ“š Search complete â€” ${data.resultCount} sources found`);
      break;
    }

    case 'human-message':
      addHumanMessage(data);
      break;

    case 'deliberation-complete':
      addCompleteBanner();
      document.getElementById('status-badge').textContent = 'Complete';
      document.getElementById('status-badge').className = 'status-badge idle';
      document.getElementById('chat-input').placeholder = 'Ask a follow-up question about this deliberation...';
      document.getElementById('btn-stop').style.display = 'none';
      stopDurationTimer();
      resetAgentStates();
      break;

    case 'session-stopped':
      document.getElementById('status-badge').textContent = 'Stopped';
      document.getElementById('status-badge').className = 'status-badge idle';
      stopDurationTimer();
      resetAgentStates();
      break;

    case 'session-state':
      currentSession = data.session;
      showView('view-deliberation');
      document.getElementById('problem-display').textContent = data.session.problem;
      document.getElementById('status-badge').textContent = data.session.active ? 'Active' : 'Complete';
      document.getElementById('status-badge').className = `status-badge ${data.session.active ? 'active' : 'idle'}`;
      if (!data.session.active) {
        document.getElementById('chat-input').placeholder = 'Ask a follow-up question about this deliberation...';
        document.getElementById('btn-stop').style.display = 'none';
      } else {
        document.getElementById('chat-input').placeholder = 'Add context, answer questions...';
        document.getElementById('btn-stop').style.display = '';
      }
      clearFeed();
      // Merge messages + human messages, sort by timestamp, interleave
      const allItems = [];
      (data.session.messages || []).forEach(m => allItems.push({ ...m, _type: 'agent' }));
      (data.session.humanMessages || []).forEach(h => allItems.push({ ...h, _type: 'human' }));
      allItems.sort((a, b) => (a.timestamp || a.createdAt || 0) - (b.timestamp || b.createdAt || 0));

      let lastPhase = '';
      allItems.forEach(item => {
        if (item._type === 'agent') {
          if (item.phase !== lastPhase) { addPhaseSeparator(item.phase); lastPhase = item.phase; }
          addMessage(item);
        } else {
          addHumanMessage(item);
        }
      });
      // Add escalation inline cards + queue items
      (data.session.escalations || []).forEach(esc => {
        addEscalationInline({ ...esc, agentId: esc.agentId });
        addEscalationToQueue(esc);
      });
      messageCount = (data.session.messages || []).length;
      escalationCount = (data.session.escalations || []).length;
      document.getElementById('info-messages').textContent = messageCount;
      document.getElementById('info-escalations').textContent = escalationCount;
      break;

    case 'session-deleted':
      sessionsList = sessionsList.filter(s => s.id !== data.sessionId);
      renderSessionList();
      showToast('ğŸ—‘ï¸ Session deleted');
      break;

    case 'error':
      showToast(`âš ï¸ ${data.message}`);
      break;
  }
}

// â”€â”€â”€ Render Agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAgents() {
  const html = agents.map(a => `
    <div class="sheet-agent" id="agent-${a.id}">
      <div class="sa-emoji">${a.emoji}</div>
      <div class="sa-info">
        <div class="sa-name" style="color:${a.color}">${a.name}</div>
        <div class="sa-role">${a.role}</div>
      </div>
      <div class="sa-dot" id="dot-${a.id}"></div>
    </div>
  `).join('');
  document.getElementById('sheet-agent-list').innerHTML = html;
  document.getElementById('desktop-agent-list').innerHTML = html.replace(/id="agent-/g, 'id="dagent-').replace(/id="dot-/g, 'id="ddot-');
}

function updateAgentState(agentId, state) {
  ['', 'd'].forEach(prefix => {
    const card = document.getElementById(`${prefix}agent-${agentId}`);
    const dot = document.getElementById(`${prefix}dot-${agentId}`);
    if (card) card.className = `sheet-agent ${state}`;
    if (dot) dot.className = `sa-dot ${state}`;
  });
}

function resetAgentStates() { agents.forEach(a => updateAgentState(a.id, 'idle')); }

// â”€â”€â”€ Render Phases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhases() {
  const html = phases.map((p, i) => `
    <div class="sheet-phase" id="phase-${i}">
      <div class="sp-dot"></div>
      <span>${p.name}</span>
    </div>
  `).join('');
  document.getElementById('sheet-phase-list').innerHTML = html;
  document.getElementById('desktop-phases').innerHTML = html.replace(/id="phase-/g, 'id="dphase-');
}

function updatePhases(activeIdx) {
  phases.forEach((_, i) => {
    ['', 'd'].forEach(prefix => {
      const el = document.getElementById(`${prefix}phase-${i}`);
      if (!el) return;
      el.className = i < activeIdx ? 'sheet-phase completed' : i === activeIdx ? 'sheet-phase active' : 'sheet-phase';
    });
  });
}

// â”€â”€â”€ Session List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSessionList() {
  const container = document.getElementById('session-list-container');
  const list = document.getElementById('session-list');
  if (!sessionsList.length) { container.style.display = 'none'; return; }
  container.style.display = 'block';
  list.innerHTML = sessionsList.map(s => {
    const date = new Date(s.createdAt).toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const status = s.active ? 'ğŸŸ¢' : 'âœ…';
    return `<div class="session-item" data-sid="${s.id}">
      <div class="si-status ${s.active ? 'active' : 'done'}"></div>
      <div class="si-info">
        <div class="si-problem">${status} ${escHtml(s.problem)}</div>
        <div class="si-meta">${date} Â· ${s.messageCount || 0} msgs Â· Phase ${s.phase || 0}/4</div>
      </div>
      <button class="si-delete" data-sid="${s.id}" title="Delete session">âœ•</button>
    </div>`;
  }).join('');
  // Open session on click
  list.querySelectorAll('.si-info').forEach(el => {
    el.addEventListener('click', () => {
      const sid = el.closest('.session-item').dataset.sid;
      if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'join-session', sessionId: sid }));
    });
  });
  // Delete session on button click
  list.querySelectorAll('.si-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const sid = btn.dataset.sid;
      if (confirm('Delete this session permanently?')) {
        sessionsList = sessionsList.filter(s => s.id !== sid);
        renderSessionList();
        if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'delete-session', sessionId: sid }));
      }
    });
  });
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â”€â”€â”€ Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearFeed() { document.getElementById('feed').innerHTML = ''; }
function scrollFeed() { const f = document.getElementById('feed'); requestAnimationFrame(() => f.scrollTop = f.scrollHeight); }

function addPhaseSeparator(name) {
  const d = document.createElement('div');
  d.className = 'phase-separator';
  d.innerHTML = `<div class="line"></div><div class="label">â–¸ ${name}</div><div class="line"></div>`;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}

function addMessage(msg) {
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const content = msg.content.replace(/NEED_HUMAN_INPUT:\s*.+/g, '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').trim();
  const d = document.createElement('div');
  d.className = 'message';
  d.innerHTML = `
    <div class="message-header">
      <div class="message-badge" style="border-color:${msg.agentColor}40"><span class="emoji">${msg.agentEmoji}</span><span style="color:${msg.agentColor}">${msg.agentName}</span></div>
      <span class="message-phase">${msg.phase}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-body" style="border-color:${msg.agentColor}15">${content}</div>
  `;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}

function showThinking(agentId) {
  removeThinking(agentId);
  const agent = agents.find(a => a.id === agentId);
  if (!agent) return;
  const d = document.createElement('div');
  d.className = 'thinking-indicator'; d.id = `thinking-${agentId}`;
  const matrixChars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³01ã‚µã‚·ã‚¹ã‚»ã‚½10ã‚¿ãƒãƒ„ãƒ†ãƒˆ';
  const randChars = Array.from({length:12}, () => matrixChars[Math.floor(Math.random()*matrixChars.length)]).join('');
  d.innerHTML = `
    <div class="message-badge" style="border-color:${agent.color}40"><span class="emoji">${agent.emoji}</span><span style="color:${agent.color}">${agent.name}</span></div>
    <div class="thinking-spinner"><div class="thinking-spinner-ring"></div><div class="thinking-spinner-core"></div></div>
    <div class="thinking-text"><span class="thinking-label">analyzing...</span><span class="thinking-chars">${randChars}</span></div>
  `;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}
function removeThinking(agentId) { const el = document.getElementById(`thinking-${agentId}`); if (el) el.remove(); }

function addSearchIndicator(queries) {
  const existing = document.getElementById('search-indicator');
  if (existing) existing.remove();
  const d = document.createElement('div');
  d.className = 'thinking-indicator'; d.id = 'search-indicator';
  d.style.background = 'rgba(65,160,255,0.06)';
  d.style.borderRadius = 'var(--radius)';
  d.style.border = '1px solid rgba(65,160,255,0.2)';
  d.innerHTML = `
    <div class="message-badge" style="border-color:rgba(65,160,255,0.3)"><span class="emoji">ğŸ”</span><span style="color:#41a0ff">Research Scout</span></div>
    <div class="thinking-dots"><span style="background:#41a0ff"></span><span style="background:#41a0ff"></span><span style="background:#41a0ff"></span></div>
    <span class="thinking-label" style="color:rgba(65,160,255,0.7)">searching: ${queries.map(q => '"' + q.slice(0,40) + '"').join(', ')}</span>
  `;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}


function addEscalationInline(data) {
  const agent = agents.find(a => a.id === data.agentId);
  const d = document.createElement('div');
  d.className = 'escalation-card'; d.id = `esc-${data.id}`;
  d.innerHTML = `
    <div class="esc-header-row">
      <div class="esc-header">âš ï¸ Input Required â€” ${agent ? agent.name : 'Agent'}</div>
      <button class="esc-dismiss" data-id="${data.id}" title="Dismiss">âœ•</button>
    </div>
    <div class="esc-question">${data.question}</div>
    <div class="esc-input-row">
      <input type="text" class="esc-input" id="esc-in-${data.id}" placeholder="Your response...">
      <button class="esc-submit" data-id="${data.id}">â–¸</button>
    </div>
  `;
  document.getElementById('feed').appendChild(d);
  d.querySelector(`#esc-in-${data.id}`).addEventListener('keydown', e => { if (e.key === 'Enter') respondEscalation(data.id); });
  d.querySelector('.esc-submit').addEventListener('click', () => respondEscalation(data.id));
  d.querySelector('.esc-dismiss').addEventListener('click', () => dismissEscalation(data.id));
  scrollFeed();
}

function addEscalationToQueue(data) {
  const agent = agents.find(a => a.id === data.agentId);
  ['sheet-esc-list', 'desktop-escalations'].forEach(containerId => {
    const container = document.getElementById(containerId);
    if (container.querySelector('span')) container.innerHTML = '';
    const d = document.createElement('div');
    d.className = `sheet-esc ${data.answered ? 'answered' : ''}`;
    d.innerHTML = `<div class="se-agent">${agent ? agent.emoji : 'â“'} ${agent ? agent.name : 'Agent'}</div><div class="se-question">${data.question}</div>`;
    d.addEventListener('click', () => {
      closeSheet();
      const el = document.getElementById(`esc-${data.id}`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    container.appendChild(d);
  });
}

function respondEscalation(escId) {
  const input = document.getElementById(`esc-in-${escId}`);
  if (!input || !input.value.trim() || !currentSession) return;
  ws.send(JSON.stringify({ type: 'escalation-response', sessionId: currentSession.id, escalationId: escId, answer: input.value.trim() }));
}

function dismissEscalation(escId) {
  const el = document.getElementById(`esc-${escId}`);
  if (el) el.classList.add('dismissed');
}

function markEscalationAnswered(escId, answer) {
  const el = document.getElementById(`esc-${escId}`);
  if (el) {
    el.classList.add('answered');
    const row = el.querySelector('.esc-input-row');
    if (row) row.innerHTML = `<div class="esc-answer">âœ… ${answer}</div>`;
    el.querySelector('.esc-header').textContent = 'âœ… Answered';
  }
}

function addHumanMessage(data) {
  const time = new Date(data.timestamp || data.createdAt || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const d = document.createElement('div');
  d.className = 'message human-msg';
  d.innerHTML = `
    <div class="message-header">
      <div class="message-badge"><span class="emoji">ğŸ‘¤</span><span style="color:var(--green)">You</span></div>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-body">${data.content}</div>
  `;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}

function addCompleteBanner() {
  const d = document.createElement('div');
  d.className = 'complete-banner';
  d.innerHTML = `<h3>âœ… Deliberation Complete</h3><p>Review the synthesis above for findings and recommendations.</p>`;
  document.getElementById('feed').appendChild(d);
  scrollFeed();
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitFromWelcome() {
  const textarea = document.getElementById('welcome-input');
  let problem = textarea.value.trim();
  if (!problem && !pendingFiles.length) { showToast('âš ï¸ Describe a problem'); return; }
  if (!problem) problem = 'Analyze the attached file(s).';
  if (!ws || ws.readyState !== 1) { showToast('âš ï¸ Reconnecting...'); connect(); return; }

  const btn = document.getElementById('welcome-submit');
  btn.disabled = true; btn.textContent = 'â³ Uploading...';

  const files = await uploadFiles();
  btn.textContent = 'âš¡ Deploying...';
  ws.send(JSON.stringify({ type: 'new-session', problem, files }));
  textarea.value = '';
  pendingFiles = [];
  renderFileList();
  btn.disabled = false;
  btn.textContent = 'âš¡ Deploy War Room';
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const content = input.value.trim();
  if (!content || !currentSession || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'human-message', sessionId: currentSession.id, content }));
  input.value = '';
}

function stopSession() {
  if (!currentSession || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'stop-session', sessionId: currentSession.id }));
}

// â”€â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFile(file) {
  if (file.size > 10 * 1024 * 1024) { showToast(`âš ï¸ ${file.name} too large`); return; }
  pendingFiles.push(file);
  renderFileList();
}
function renderFileList() {
  const list = document.getElementById('file-list');
  if (!pendingFiles.length) { list.innerHTML = ''; return; }
  list.innerHTML = pendingFiles.map((f, i) => {
    const sz = f.size < 1024 ? f.size + 'B' : (f.size / 1024).toFixed(1) + 'KB';
    return `<div class="file-chip">ğŸ“„ ${f.name} (${sz}) <span class="remove-file" data-idx="${i}">Ã—</span></div>`;
  }).join('');
  list.querySelectorAll('.remove-file').forEach(el => el.addEventListener('click', () => { pendingFiles.splice(+el.dataset.idx, 1); renderFileList(); }));
}
async function uploadFiles() {
  if (!pendingFiles.length) return [];
  const fd = new FormData();
  pendingFiles.forEach(f => fd.append('files', f));
  try {
    const res = await fetch(apiUrl('/api/upload'), { method: 'POST', body: fd });
    if (!res.ok) { showToast(`âš ï¸ Upload failed`); return []; }
    return (await res.json()).files || [];
  } catch (e) { showToast('âš ï¸ Upload failed'); return []; }
}

const dropZone = document.getElementById('file-drop-zone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); Array.from(e.dataTransfer.files).forEach(addFile); });
document.getElementById('file-input').addEventListener('change', e => { Array.from(e.target.files).forEach(addFile); e.target.value = ''; });

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('visible');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(() => t.classList.remove('visible'), 3500);
}

function startDurationTimer() {
  stopDurationTimer();
  durationInterval = setInterval(() => {
    if (!sessionStart) return;
    const s = Math.floor((Date.now() - sessionStart) / 1000);
    document.getElementById('info-duration').textContent = `${Math.floor(s/60)}m ${s%60}s`;
  }, 1000);
}
function stopDurationTimer() { if (durationInterval) clearInterval(durationInterval); }

// â”€â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-back').addEventListener('click', goHome);
document.getElementById('welcome-submit').addEventListener('click', submitFromWelcome);
document.getElementById('welcome-input').addEventListener('keydown', e => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) submitFromWelcome(); });
document.getElementById('btn-send').addEventListener('click', sendMessage);
document.getElementById('btn-stop').addEventListener('click', stopSession);
document.getElementById('chat-input').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

// Back to welcome on logo tap
document.querySelector('.logo').addEventListener('click', goHome);

function goHome() {
  currentSession = null;
  showView('view-welcome');
  document.getElementById('problem-display').textContent = '';
  document.getElementById('status-badge').textContent = 'Idle';
  document.getElementById('status-badge').className = 'status-badge idle';
  stopDurationTimer();
  if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'get-sessions' }));
}

// Clear all sessions
document.getElementById('clear-all-sessions').addEventListener('click', () => {
  if (!sessionsList.length) return;
  if (!confirm(`Delete all ${sessionsList.length} sessions permanently?`)) return;
  sessionsList.forEach(s => {
    if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'delete-session', sessionId: s.id }));
  });
  sessionsList = [];
  renderSessionList();
});

// â”€â”€â”€ Copy-to-clipboard on message bodies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function injectCopyBtn(body) {
  if (body.querySelector('.copy-btn')) return;
  const btn = document.createElement('button');
  btn.className = 'copy-btn'; btn.textContent = 'â§‰ Copy';
  btn.setAttribute('aria-label', 'Copy to clipboard');
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const text = body.innerText || body.textContent;
    try { await navigator.clipboard.writeText(text); } catch { /* fallback */ const ta = document.createElement('textarea'); ta.value = text; ta.style.cssText = 'position:fixed;opacity:0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    btn.textContent = 'âœ“ Copied'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'â§‰ Copy'; btn.classList.remove('copied'); }, 1500);
  });
  body.appendChild(btn);
}
// Observe feed for new messages
const feedEl = document.getElementById('feed');
new MutationObserver(() => {
  feedEl.querySelectorAll('.message-body').forEach(injectCopyBtn);
}).observe(feedEl, { childList: true, subtree: true });
// Inject on any already rendered
feedEl.querySelectorAll('.message-body').forEach(injectCopyBtn);

// â”€â”€â”€ Command Palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cmdOverlay = document.getElementById('cmd-overlay');
const cmdInput = document.getElementById('cmd-input');
const cmdResults = document.getElementById('cmd-results');
let cmdSelectedIdx = -1;
let cmdItems = [];
let cmdSearchTimeout = null;

const CMD_ACTIONS = [
  { id: 'new-session', icon: 'âš¡', title: 'New Session', meta: 'Start a new deliberation', action: () => { closeCmdPalette(); goHome(); document.getElementById('welcome-input').focus(); }},
  { id: 'go-home', icon: 'ğŸ ', title: 'Home', meta: 'Back to session list', action: () => { closeCmdPalette(); goHome(); }},
];

function openCmdPalette() {
  cmdOverlay.classList.add('open');
  cmdInput.value = '';
  cmdSelectedIdx = -1;
  renderCmdDefaults();
  setTimeout(() => cmdInput.focus(), 50);
}

function closeCmdPalette() {
  cmdOverlay.classList.remove('open');
  cmdInput.value = '';
  cmdResults.innerHTML = '';
}

function renderCmdDefaults() {
  cmdItems = [...CMD_ACTIONS];
  // Also show recent sessions
  const recent = sessionsList.slice(0, 5);
  recent.forEach(s => {
    cmdItems.push({
      id: 'session-' + s.id, icon: s.active ? 'ğŸŸ¢' : 'âœ…',
      title: s.problem, meta: `${s.messageCount || 0} msgs Â· Phase ${s.phase || 0}/4`,
      badge: s.active ? 'ACTIVE' : null,
      action: () => { closeCmdPalette(); if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'join-session', sessionId: s.id })); }
    });
  });
  renderCmdItems();
}

function renderCmdItems() {
  cmdResults.innerHTML = cmdItems.map((item, i) => `
    <div class="cmd-item${i === cmdSelectedIdx ? ' selected' : ''}" data-idx="${i}">
      <span class="cmd-item-icon">${item.icon}</span>
      <div class="cmd-item-info">
        <div class="cmd-item-title">${escHtml(item.title)}</div>
        ${item.meta ? `<div class="cmd-item-meta">${escHtml(item.meta)}</div>` : ''}
      </div>
      ${item.badge ? `<span class="cmd-item-badge">${item.badge}</span>` : ''}
    </div>
  `).join('');
  cmdResults.querySelectorAll('.cmd-item').forEach(el => {
    el.addEventListener('click', () => { const idx = +el.dataset.idx; if (cmdItems[idx]) cmdItems[idx].action(); });
    el.addEventListener('mouseenter', () => { cmdSelectedIdx = +el.dataset.idx; highlightCmd(); });
  });
}

function highlightCmd() {
  cmdResults.querySelectorAll('.cmd-item').forEach((el, i) => {
    el.classList.toggle('selected', i === cmdSelectedIdx);
    if (i === cmdSelectedIdx) el.scrollIntoView({ block: 'nearest' });
  });
}

async function searchSessions(query) {
  if (!query) { renderCmdDefaults(); return; }
  // Filter commands
  const matchedActions = CMD_ACTIONS.filter(a => a.title.toLowerCase().includes(query.toLowerCase()));
  try {
    const res = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}`));
    const sessions = await res.json();
    cmdItems = [...matchedActions];
    sessions.forEach(s => {
      cmdItems.push({
        id: 'session-' + s.id, icon: s.active ? 'ğŸŸ¢' : 'âœ…',
        title: s.problem, meta: `${s.messageCount || 0} msgs Â· Phase ${s.phase || 0}/4`,
        badge: s.active ? 'ACTIVE' : null,
        action: () => { closeCmdPalette(); if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'join-session', sessionId: s.id })); }
      });
    });
    if (!cmdItems.length) cmdResults.innerHTML = '<div style="padding:20px 16px;text-align:center;font-size:12px;color:var(--text-dimmer)">No results found</div>';
    else { cmdSelectedIdx = 0; renderCmdItems(); }
  } catch { renderCmdDefaults(); }
}

cmdInput.addEventListener('input', () => {
  clearTimeout(cmdSearchTimeout);
  const q = cmdInput.value.trim();
  cmdSearchTimeout = setTimeout(() => searchSessions(q), 200);
});

cmdInput.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowDown') { e.preventDefault(); cmdSelectedIdx = Math.min(cmdSelectedIdx + 1, cmdItems.length - 1); highlightCmd(); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); cmdSelectedIdx = Math.max(cmdSelectedIdx - 1, 0); highlightCmd(); }
  else if (e.key === 'Enter') { e.preventDefault(); if (cmdItems[cmdSelectedIdx]) cmdItems[cmdSelectedIdx].action(); }
  else if (e.key === 'Escape') { closeCmdPalette(); }
});

cmdOverlay.addEventListener('click', (e) => { if (e.target === cmdOverlay) closeCmdPalette(); });

// Global Cmd+K / Ctrl+K listener
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    if (cmdOverlay.classList.contains('open')) closeCmdPalette();
    else openCmdPalette();
  }
  if (e.key === 'Escape' && cmdOverlay.classList.contains('open')) closeCmdPalette();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect();
</script>
</body>
</html>
